name: Convert XML to Simplified and Traditional Chinese

on:
  push:
    paths:
      - "epgziyong.xml"              # åªæœ‰ epgziyong.xml æ”¹åŠ¨æ—¶è§¦å‘
  schedule:
    - cron: '25 */1 * * *'           # æ¯å°æ—¶ç¬¬ 25 åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:                 # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install opencc
          sudo apt-get update
          sudo apt-get install -y gzip

      - name: Convert epgziyong.xml â†’ Simplified & Traditional + Compress
        run: |
          python - <<'EOF'
          from opencc import OpenCC
          import os, gzip

          input_file = "epgziyong.xml"
          if not os.path.exists(input_file):
              raise FileNotFoundError(f"{input_file} ä¸å­˜åœ¨")

          # åˆå§‹åŒ–ä¸¤ä¸ªè½¬æ¢å™¨
          cc_t2s = OpenCC('t2s')  # ç¹ â†’ ç®€
          cc_s2t = OpenCC('s2t')  # ç®€ â†’ ç¹

          with open(input_file, "r", encoding="utf-8") as f:
              text = f.read()

          # --- ç¹è½¬ç®€ ---
          simplified = cc_t2s.convert(text)
          with open("swepg.xml", "w", encoding="utf-8") as f:
              f.write(simplified)
          with open("swepg.xml", "rb") as f_in, gzip.open("swepg.xml.gz", "wb") as f_out:
              f_out.writelines(f_in)
          print("âœ… å·²ç”Ÿæˆ swepg.xml å’Œ swepg.xml.gzï¼ˆç¹â†’ç®€ï¼‰")

          # --- ç®€è½¬ç¹ ---
          traditional = cc_s2t.convert(text)
          with open("twepg.xml", "w", encoding="utf-8") as f:
              f.write(traditional)
          with open("twepg.xml", "rb") as f_in, gzip.open("twepg.xml.gz", "wb") as f_out:
              f_out.writelines(f_in)
          print("âœ… å·²ç”Ÿæˆ twepg.xml å’Œ twepg.xml.gzï¼ˆç®€â†’ç¹ï¼‰")
          EOF

      - name: Commit and push result
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          changes=0
          for f in swepg.xml swepg.xml.gz twepg.xml twepg.xml.gz; do
            if [ -s "$f" ]; then
              git add "$f"
              echo "âœ… å·²æ·»åŠ  $f"
              changes=1
            else
              echo "âš ï¸ $f ç‚ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œç•¥é"
            fi
          done

          if [ "$changes" -eq 1 ]; then
            git commit -m "Auto convert epgziyong.xml â†’ swepg/twepg (Simplified & Traditional) and compress"
            git pull --rebase
            git push
            echo "ğŸš€ è®Šæ›´å·²æˆåŠŸæäº¤åˆ°å€‰åº«"
          else
            echo "ğŸ›‘ ç„¡è®Šæ›´å¯æäº¤"
          fi
