name: Convert to Traditional Chinese

on:
  push:
    paths:
      - "epgziyong.xml"            # åªæœ‰ epgziyong.xml æ”¹å‹•æ™‚æ‰è§¸ç™¼

  schedule:
    - cron: '27 */1 * * *'          # æ¯å°æ™‚çš„ç¬¬ 27 åˆ†é˜åŸ·è¡Œ

  workflow_dispatch:               # æ‰‹å‹•è§¸ç™¼æ”¯æŒ

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install opencc

      - name: Convert epgziyong.xml (Simplified â†’ Traditional) and Compress
        run: |
          python - <<'EOF'
          from opencc import OpenCC
          import os, gzip

          input_file = "epgziyong.xml"
          output_file = "twepg.xml"
          gzip_file = output_file + ".gz"

          if not os.path.exists(input_file):
              raise FileNotFoundError(f"{input_file} ä¸å­˜åœ¨")

          # åˆå§‹åŒ–è½‰æ›å™¨ï¼šç°¡é«”è½‰ç¹é«”
          cc = OpenCC('s2t')

          with open(input_file, "r", encoding="utf-8") as f:
              text = f.read()

          traditional = cc.convert(text)

          # å¯«å…¥ç¹é«”æ–‡ä»¶
          with open(output_file, "w", encoding="utf-8") as f:
              f.write(traditional)

          # ç”Ÿæˆå£“ç¸®æ–‡ä»¶ twepg.xml.gz
          with open(output_file, "rb") as f_in, gzip.open(gzip_file, "wb") as f_out:
              f_out.writelines(f_in)

          print(f"âœ… å·²ç”Ÿæˆ {output_file} å’Œ {gzip_file}")
          EOF

      - name: Commit and push result
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          changes=0

          if [ -s twepg.xml ]; then
            git add twepg.xml
            changes=1
            echo "âœ… å·²æ·»åŠ  twepg.xml"
          else
            echo "âš ï¸ ç”Ÿæˆå¤±æ•—ï¼štwepg.xml ç‚ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

          if [ -s twepg.xml.gz ]; then
            git add twepg.xml.gz
            changes=1
            echo "âœ… å·²æ·»åŠ  twepg.xml.gz"
          else
            echo "âš ï¸ ç”Ÿæˆå¤±æ•—ï¼štwepg.xml.gz ç‚ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

          if [ "$changes" -eq 1 ]; then
            echo "ğŸ“¥ æ­£åœ¨åŒæ­¥æœ€æ–° main åˆ†æ”¯..."
            git fetch origin main
            git rebase origin/main || git rebase --abort
            echo "ğŸ“ æäº¤æ›´æ–°..."
            git commit -m "Auto convert epgziyong.xml from Simplified to Traditional Chinese and compress"
            echo "ğŸš€ æ¨é€åˆ°é ç«¯å€‰åº«..."
            git push origin main
            echo "âœ… å·²æˆåŠŸæäº¤ä¸¦æ¨é€æ›´æ–°"
          else
            echo "ğŸ›‘ ç„¡è®Šæ›´å¯æäº¤"
          fi
