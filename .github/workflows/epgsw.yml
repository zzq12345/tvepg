name: Convert  to Simplified Chinese

on:
  push:
    paths:
      - "epgziyong.xml"          # åªæœ‰ epgziyong.xml æœ‰æ›´å‹•æ‰æœƒè§¸ç™¼
  workflow_dispatch:             # å…è¨±æ‰‹å‹•åŸ·è¡Œ
  schedule:
    - cron: '23 */1 * * *'        # æ¯å°æ™‚ç¬¬ 2 åˆ†é˜åŸ·è¡Œä¸€æ¬¡

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install opencc
          sudo apt-get update
          sudo apt-get install -y gzip

      - name: Convert and compress
        run: |
          python - <<'EOF'
          from opencc import OpenCC
          import os

          input_file = "epgziyong.xml"
          output_file = "swepg.xml"

          if not os.path.exists(input_file):
              raise FileNotFoundError(f"{input_file} ä¸å­˜åœ¨")

          cc = OpenCC('t2s')
          with open(input_file, "r", encoding="utf-8") as f:
              text = f.read()

          simplified = cc.convert(text)

          with open(output_file, "w", encoding="utf-8") as f:
              f.write(simplified)

          print(f"âœ… å·²ç”Ÿæˆ {output_file}")
          EOF

          # å£“ç¸® swepg.xml ç‚º swepg.xml.gz
          gzip -kf swepg.xml
          echo "âœ… å·²å£“ç¸®ç‚º swepg.xml.gz"

      - name: Commit and push result
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com" changes=0
          if [ -s twepg.xml ]; then
          git add twepg.xml
          changes=1
          echo "âœ… å·²æ·»åŠ  twepg.xml"
           else
           echo "âš ï¸ ç”Ÿæˆå¤±æ•—ï¼štwepg.xml ç‚ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

          if [ -s twepg.xml.gz ]; then
          git add twepg.xml.gz
          changes=1
          echo "âœ… å·²æ·»åŠ  twepg.xml.gz"
          else
          echo "âš ï¸ ç”Ÿæˆå¤±æ•—ï¼štwepg.xml.gz ç‚ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

          if [ "$changes" -eq 1 ]; then
          git commit -m "Auto convert epgziyong.xml from Simplified to Traditional Chinese and compress"
  
          echo "ğŸ”„ å˜—è©¦åŒæ­¥é ç«¯ main åˆ†æ”¯..."
          git pull --rebase origin main || {
          echo "âš ï¸ è‡ªå‹• rebase å¤±æ•—ï¼Œå˜—è©¦å¼·åˆ¶æ¨é€"
          git push origin main --force
          exit 0
          }
  
          git push origin main
          echo "ğŸš€ è®Šæ›´å·²æˆåŠŸæäº¤åˆ°å€‰åº«"
          else
          echo "ğŸ›‘ ç„¡è®Šæ›´å¯æäº¤"
          fi
