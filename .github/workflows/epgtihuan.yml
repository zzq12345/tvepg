name: epgtihuan

on:
  schedule:
    - cron: '11 */1 * * *'  # æ¯å°æ—¶çš„ç¬¬ 11 åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºå½“å‰ä»“åº“
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® PHP ç¯å¢ƒ
      - name: Set up PHP 7.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      # ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œ PHP è„šæœ¬ç”Ÿæˆ EPG æ–‡ä»¶
      - name: Run epggen2.php
        run: php epggen2.php

      # ç¬¬å››æ­¥ï¼šæ£€å‡ºç›®æ ‡ä»“åº“åˆ°å­ç›®å½• tvepg
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: zzq12345/tvepg
          token: ${{ secrets.GITHUB_TOKEN }}
          path: tvepg

      # ç¬¬äº”æ­¥ï¼šå¤åˆ¶ç”Ÿæˆçš„æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      - name: Overwrite target files
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
          ls -l

          echo "ğŸ“¦ æ‹·è´æ–‡ä»¶åˆ° tvepg ä»“åº“"
          cp -f epgshanghai.xml tvepg/epgshanghai.xml
          cp -f epghebeiiptv1.xml tvepg/epghebeiiptv1.xml
          cp -f epgyidong.xml tvepg/epgyidong.xml

          echo "âœ… æ–‡ä»¶å·²æ›´æ–°åˆ° tvepg ç›®å½•:"
          ls -l tvepg

      # ç¬¬å…­æ­¥ï¼šæäº¤å¹¶æ¨é€å˜æ›´
      - name: Commit and push
        run: |
          cd tvepg
          echo "ğŸ” å½“å‰ Git çŠ¶æ€:"
          git status
          git diff || true

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åŒæ­¥è¿œç«¯æœ€æ–°æäº¤å¹¶ rebase
          git fetch origin main
          if ! git rebase origin/main; then
            echo "âš ï¸ Rebase å‘ç”Ÿå†²çªï¼Œå·²ä¸­æ­¢"
            git rebase --abort
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git add -A
            git commit -m "è‡ªåŠ¨æ›´æ–°æ—¶é—´ï¼š$now_time"
            git push origin main --force-with-lease
            echo "âœ… å·²æ¨é€æ›´æ–°ï¼š$now_time"
          else
            echo "â„¹ï¸ æ— æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi
