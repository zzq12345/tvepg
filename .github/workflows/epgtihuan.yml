name: epgtihuan

on:
  schedule:
    - cron: '11 */1 * * *'   # æ¯å°æ™‚ç¬¬ 11 åˆ†é˜åŸ·è¡Œ
  workflow_dispatch:           # æ”¯æ´æ‰‹å‹•è§¸ç™¼

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæª¢å‡ºç•¶å‰å€‰åº«ï¼ˆç”Ÿæˆè…³æœ¬æ‰€åœ¨å€‰åº«ï¼‰
      - name: Checkout source repo
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè¨­å®š PHP ç’°å¢ƒ
      - name: Set up PHP 7.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      # ç¬¬ä¸‰æ­¥ï¼šåŸ·è¡Œç”Ÿæˆè…³æœ¬
      - name: Run epggen2.php
        run: php epggen2.php

      # ç¬¬å››æ­¥ï¼šæª¢å‡ºç›®æ¨™å€‰åº«åˆ°å­ç›®éŒ„ tvepg
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: zzq12345/tvepg
          token: ${{ secrets.GITHUB_TOKEN }}
          path: tvepg

      # ç¬¬äº”æ­¥ï¼šè¦†è“‹ç›®æ¨™å€‰åº«ä¸­çš„æª”æ¡ˆ
      - name: Overwrite target files
        run: |
          echo "ğŸ“‚ æª¢æŸ¥ç”Ÿæˆçš„æª”æ¡ˆ..."
          ls -l epgshanghai.xml epghebeiiptv1.xml epgyidong.xml

          echo "ğŸ” è¦†è“‹åˆ° tvepg ç›®éŒ„..."
          cp -f epgshanghai.xml tvepg/epgshanghai.xml
          cp -f epghebeiiptv1.xml tvepg/epghebeiiptv1.xml
          cp -f epgyidong.xml tvepg/epgyidong.xml

          echo "âœ… è¦†è“‹å¾Œæª”æ¡ˆæ¸…å–®ï¼š"
          ls -l tvepg/*.xml

      # ç¬¬å…­æ­¥ï¼šæäº¤ä¸¦æ¨é€è®Šæ›´
      - name: Commit and push changes
        working-directory: tvepg
        run: |
          echo "ğŸ”§ è¨­å®š Git ç’°å¢ƒ..."
          git config --global --add safe.directory "$(pwd)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ“¡ åŒæ­¥é ç«¯..."
          git fetch origin main
          git rebase origin/main || {
            echo "âš ï¸ Rebase é‡åˆ°è¡çªï¼Œé€€å‡º workflow"
            git rebase --abort
            exit 1
          }

          echo "ğŸ§© æª¢æŸ¥ç›®å‰ç‹€æ…‹..."
          git status
          git diff || true

          echo "ğŸ“¦ åŠ å…¥æ‰€æœ‰è®Šæ›´..."
          git add -A

          echo "---- æª¢æŸ¥ staged ç‹€æ…‹ ----"
          git diff --cached || true

          # åªæœ‰åœ¨æœ‰è®Šæ›´æ™‚æ‰æäº¤
          if [ -n "$(git diff --cached)" ]; then
            now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æ›´æ–°æ—¶é—´ï¼š$now_time"
            git push origin main --force-with-lease
            echo "âœ… æˆåŠŸæäº¤ä¸¦æ¨é€è®Šæ›´"
          else
            echo "âš ï¸ ç„¡å¯¦éš›å…§å®¹è®Šæ›´ï¼Œè·³éæäº¤èˆ‡æ¨é€"
          fi
