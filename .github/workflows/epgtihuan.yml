name: epgtihuan

on:
  schedule:
    - cron: '11 */1 * * *'  # æ¯å°æ—¶ç¬¬ 11 åˆ†é’Ÿæ‰§è¡Œ
  workflow_dispatch:

jobs:
  generate_and_upload:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºæºä»“åº“
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® PHP ç¯å¢ƒ
      - name: Set up PHP 7.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      # 3ï¸âƒ£ è¿è¡Œ PHP ç”Ÿæˆæ–‡ä»¶
      - name: Run epggen2.php
        run: php epggen2.php

      # 4ï¸âƒ£ æ£€å‡ºç›®æ ‡ä»“åº“åˆ° tvepg å­ç›®å½•
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: zzq12345/tvepg
          token: ${{ secrets.GITHUB_TOKEN }}
          path: tvepg

      # 5ï¸âƒ£ æ‹·è´ç”Ÿæˆçš„æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      - name: Copy updated XML files
        run: |
          echo "ğŸ“¦ æ‹·è´ç”Ÿæˆçš„ XML æ–‡ä»¶..."
          cp -f epgshanghai.xml tvepg/epgshanghai.xml
          cp -f epghebeiiptv1.xml tvepg/epghebeiiptv1.xml
          cp -f epgyidong.xml tvepg/epgyidong.xml
          echo "âœ… æ–‡ä»¶å·²å¤åˆ¶ï¼š"
          ls -l tvepg/*.xml

      # 6ï¸âƒ£ æäº¤å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
      - name: Commit and push changes
        run: |
          cd tvepg
          echo "ğŸ” å½“å‰ Git çŠ¶æ€:"
          git status

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          if ! git rebase origin/main; then
            echo "âš ï¸ Rebase å‘ç”Ÿå†²çªï¼Œå·²ä¸­æ­¢"
            git rebase --abort
            exit 1
          fi

          # ğŸ”§ å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶åˆ·æ–°ç´¢å¼•ã€é‡æ–°æ£€æµ‹ä¿®æ”¹
          git update-index --refresh
          git add -A
          git status

          if [ -n "$(git diff --cached)" ]; then
            now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æ›´æ–°æ—¶é—´ï¼š$now_time"
            git push origin main --force-with-lease
            echo "âœ… å·²æ¨é€æ›´æ–°ï¼š$now_time"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æ–°å˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi
